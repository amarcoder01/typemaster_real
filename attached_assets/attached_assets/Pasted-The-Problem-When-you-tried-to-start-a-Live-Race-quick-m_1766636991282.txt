The Problem
When you tried to start a "Live Race" (quick match), the bots were not joining and the race was stuck showing "Preparing..." forever.
Root Cause Analysis
I found 3 main issues:
Issue 1: Bots Were Never Created
The botService.addBotsToRace() function existed in the code but was never called anywhere. This means when you created a race, no bots were ever added to it.
Location: server/bot-service.ts had the function, but server/routes.ts never used it.
Issue 2: Race Required 2 Human Players
The WebSocket handleReady function had this check:
// OLD CODE - Required 2 humans to startconst requiredPlayers = 2;if (connectedHumans.length < requiredPlayers) {  // Send error - not enough players}
Even if bots existed, the race wouldn't start with just 1 human player.
Issue 3: Race Cache Was Stale
When bots were added to the database, the race cache was not updated. So when handleReady checked for bots, it looked at the cached data which didn't include the bots.
The Fixes
Fix 1: Add Bots When Creating Quick Match Race
File: server/routes.ts (line ~2378)
// NEW CODE - Add bots after creating raceconst botCount = 3;const addedBots = await botService.addBotsToRace(race.id, botCount);console.log([Quick Match] Added ${addedBots.length} bots to new race ${race.id});
Now when you do a quick match, 3 bots are automatically added to race against you.
Fix 2: Allow 1 Human + Bots to Start Race
File: server/websocket.ts (line ~742)
// NEW CODE - Check if bots existconst botParticipants = participants.filter(p => p.isBot === 1);const hasBots = botParticipants.length > 0;// With bots: only 1 human needed// Without bots: 2 humans neededconst requiredHumans = hasBots ? 1 : 2;
Now if there are bots in the race, you can start alone. If no bots, you still need 2 human players.
Fix 3: Update Race Cache After Adding Bots
File: server/routes.ts (line ~2429)
// NEW CODE - Update cache so handleReady sees the botsconst { raceCache } = await import("./race-cache");const allParticipants = await storage.getRaceParticipants(race.id);raceCache.setRace(race, allParticipants);
This ensures the WebSocket handler sees the bots when checking if the race can start.
Fix 4: Reset "Preparing" State on Errors
File: client/src/pages/race.tsx (line ~1632)
// NEW CODE - Reset UI state on errorcase "NOT_ENOUGH_PLAYERS":  toast.warning("Not enough players", { ... });  setIsStarting(false);      // Reset button  setIsTransitioning(false); // Hide "Preparing..." overlay  break;
Before, if an error occurred, the "Preparing..." screen would stay forever. Now it resets properly.
Fix 5: Added Debug Logging
File: server/websocket.ts
Added logging to track what's happening:
console.log([WS] handleReady: Race ${raceId} has ${participants.length} participants);console.log([WS] handleReady: connectedHumans: ${connectedHumans.length}, hasBots: ${hasBots});console.log([WS] handleReady: Starting countdown for race ${raceId});
This helps diagnose future issues.
Summary Flow (After Fix)
User clicks "Quick Match" → Creates race in database
Server adds 3 bots → botService.addBotsToRace(race.id, 3)
Server updates cache → Cache now has race + 4 participants (1 human, 3 bots)
User clicks "Start Race" → Sends "ready" message via WebSocket
Server checks participants → Finds 3 bots, so only 1 human needed
Countdown starts → 3... 2... 1... GO!
Bots start typing → botService.startBotTyping() for each bot
Race proceeds normally → You race against 3 AI opponents